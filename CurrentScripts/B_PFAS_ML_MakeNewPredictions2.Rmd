---
title: "New Predictions Using Dawson 2023 Halflife Model"
author: "John Wambaugh"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{New Dawson 2023 Predictions}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "c:/users/jwambaug/git/CompTox-PFASHalfLife")
```

# Use of Model to Predict Half-Lives for Novel PFAS

## Clear the workspace:
```{r clear_workspace}
rm(list=ls())
try(dev.off())
```

## Specify which RData files we are working with:
```{r configure_files}
OUTPUTFILE <- "new_invivo_Dawson2023"
NEWPFASINFO <- "threewithinvivo.csv"
INFO.SMILES.COL <- "SMILES"
NEWPFASOPERA <- "PFAStoPred-smi_OPERA2.9Pred.csv"
OPERA.ID.COL <- "MoleculeID"
NEWPFASENDO <- "EndoSubset-EPA_PFAS_DSSTox-Similarity_Wambaugh_113023.csv"
ENDO.CAS.COL <- "ENDO.CASRN..EPA.PFAS."
NEWPFASTOXPRINT <- "threewithinvivo-toxprints.tsv"
```

## Load Dawson (2023) Model
```{r dawson2023model}
MODELBUILDSUFF <- "JFW100322-noLogD" 
TRAININGSETSUFF <- "JFW012924"
```

## Configure Predictions
```{r configure_model}
SPECIES <- "Human"
SEX <- "Female"
# Dose route (Other, IV, Oral)
DOSEROUTE <- "Oral"
RNUMSEED <- "12345"
ENDO.THRESHOLD <- 0.9
```

## Load necessary libraries
```{r load_libraries}
packages <- c("readxl")
# Note, the "character.only" argument is necessary here
sapply(packages, require,character.only=TRUE)
```

## Load list of new chemicals
Need "dtxsid", "name", "casrn", "formula", "mw"
```{r load_new_pfas}
pfastopred <- read.csv(paste0("NewPFAS/",
                              NEWPFASINFO))
dim(pfastopred)
# Require SMILES:
pfastopred <- subset(pfastopred, 
                     !is.na(pfastopred[,INFO.SMILES.COL]))
dim(pfastopred)
# Remove duplicated ID's:
pfastopred<- subset(pfastopred, !duplicated(DTXSID))
dim(pfastopred)
```

## Write out SMILES for OPERA, endogenous similarity, ToxPrint
```{r write_smiles}
write.table(pfastopred[,c(INFO.SMILES.COL,"DTXSID")],
          file=paste0("NewPFAS/",
                      OUTPUTFILE,
                      "-PFAStoPred.smi"),
          row.names=FALSE,
          col.names=FALSE,
          quote = FALSE,
          sep="\t")
```

ChemoTyper (ToxPrints):
* https://github.com/mn-am/chemotyper
OPERA:
* https://ntp.niehs.nih.gov/whatwestudy/niceatm/comptox/ct-opera/opera
Endogenous descriptors:
* https://github.com/USEPA/CompTox-PFASHalfLife/tree/main/Predictors/EndoSimilarity
```{r load_predictors}
# Needs to have columns named:
# "LogP_pred", "LogVP_pred", "LogWS_pred", "LogKOA_pred"
opera.vals <- read.csv(paste0("NewPFAS/",
                              NEWPFASOPERA))

endo.vals <- read.csv(paste0("NewPFAS/",
                              NEWPFASENDO))

#To account for ether bond, load in aliphatic COC toxprint
toxprint.vals <- read.csv(paste0("NewPFAS/",
                              NEWPFASTOXPRINT),
                          sep="\t")
```

# Load predictors:
```{r load_predictors}
load(file=paste0("RData/PFAS_QSAR_Predictors_Predictions_", 
                  MODELBUILDSUFF,
                  ".RData"))
predictors <- colnames(pfasdsredsc_ds)[4:(dim(pfasdsredsc_ds)[2]-2)]
cat(paste("Need the following descriptors:",
          paste(predictors, collapse=", ")
          ))
```

```{r add_endogenous_similarity}
needed.endo <- predictors[regexpr("TSPC",predictors)!=-1]
needed.endo <- gsub("TSPC_","",needed.endo)
needed.endo <- gsub("\\.","-",needed.endo)

endo.vals <- subset(endo.vals, 
  endo.vals[,ENDO.CAS.COL] %in% needed.endo)
for (this.cas in needed.endo)
{
  for (this.id in unique(pfastopred$DTXSID))
    if (this.id %in% endo.vals$DTXSID)
    {
      col.name <- paste0("TSPC_",
                     gsub("-","\\.",this.cas))
      pfastopred[pfastopred$DTXSID==this.id, col.name] <-
      ifelse(as.numeric(endo.vals[endo.vals$DTXSID==this.id &
                endo.vals$ENDO.CASRN==this.cas,
                "Tanimoto.Score..PubChem."]) > ENDO.THRESHOLD,
             1,
             0)
  }
  pfastopred <- subset(pfastopred, 
                  !is.na(pfastopred[,col.name]))
}
```

```{r add_serum_albumin}
han.binding <- as.data.frame(read_excel(
  "Predictors/Han_et al.2012_AlbuminProteinBinding_Data.xlsx"))

pfastopred$Ka_perM_SerAlb_Han <- NA

for (this.chem in sort(unique(pfastopred$DTXSID)))
  if (this.chem %in% han.binding$DTXSID)
  {
    this.subset <- subset(han.binding, DTXSID %in% this.chem)
    if (tolower(SPECIES) %in% tolower(this.subset$Speces))
    {
      this.subset <- subset(han.binding, tolower(Species) %in%
                              tolower(SPECIES))
    }
    pfastopred[pfastopred$DTXSID %in% this.chem, "Ka_perM_SerAlb_Han"] <-
      mean(as.numeric(this.subset$Ka_perM_SerAlb_Han))
  }
```

```{r add_kidney_predictors}
kidney <- as.data.frame(read_excel(
  "Predictors/Oliver 1968_SupplementalData_JFW100322.xlsx", sheet =2))[1:11,]
kidney$Neph_Num <- as.numeric(kidney$Neph_Num)
kidney$BW <- as.numeric(kidney$BW)
kidney$KW <- as.numeric(kidney$KW)
kidney$GlomSA <- as.numeric(kidney$GlomSA)

kidney[!is.na(kidney$Neph_Num),"Log10Neph_Num"]=log10(kidney[!is.na(kidney$Neph_Num),"Neph_Num"])
kidney$Log10BW=log10(kidney$BW)
kidney$Log10KW=log10(kidney$KW)

if (!(tolower(SPECIES) %in% tolower(kidney$Mammal))) 
  stop("Kidney data for selected species unavailable")

this.row <- tolower(kidney$Mammal)==tolower(SPECIES)
for (this.param in c("GlomTotSA_KW_ratio",
                     "ProxTubDiam",
                     "GlomTotSA_ProxTubTotVol_ratio",
                     "Type"))
  pfastopred[,this.param] <- ifelse(is.na(as.numeric(
    kidney[this.row, this.param])),
    kidney[this.row, this.param],
    signif(as.numeric(kidney[this.row, this.param]),3))
```

```{r add_opera_predictors}
for (this.chem in unique(sort(pfastopred$DTXSID)))
  if (this.chem %in% opera.vals[,OPERA.ID.COL])
  {
    this.row1 <- which(pfastopred$DTXSID == this.chem)
    this.row2 <- which(opera.vals[,OPERA.ID.COL] == this.chem)
    for (this.param in c("LogP_pred",
                     "LogVP_pred",
                     "LogWS_pred",
                     "LogKOA_pred"))
      pfastopred[this.row1,this.param] <- 
        signif(as.numeric(opera.vals[this.row2, this.param]),3)
  }
```

## Structure predictors (ToxPrint)
```{r load_toxprint}
for (this.chem in unique(sort(pfastopred$DTXSID)))
  if (this.chem %in% toxprint.vals$M_NAME)
  {
    this.row1 <- which(pfastopred$DTXSID == this.chem)
    this.row2 <- which(toxprint.vals$M_NAME == this.chem)
    pfastopred[this.row1,"COC_aliphatic"] <- 
      toxprint.vals[this.row2, "bond.COC_ether_aliphatic"]
  }
```

## Scenario predictors
```{r add_scenario_predictors}
pfastopred[,"Species"] <- SPECIES
# Must have levels in same order as expected by model:
pfastopred[,"Sex"] <- factor(SEX, levels=c("Female", "Male"))
pfastopred[,"DosingAdj"] <- factor(DOSEROUTE, levels=c("IV", "Oral", "Other"))
pfastopred[,"Type"] <- factor(pfastopred[,"Type"], levels=c(
  "Multirenculated",
  "Unipapillary"))
```

## Replace missing values with averages of training set 
```{r replace_missing}
load(paste0("RData/Mean_SD_Trainingset_",
            MODELBUILDSUFF,
            ".RData"))

# Threshold the similarities:
train_msd[1,1:3] <- ifelse(train_msd[1,1:3] > ENDO.THRESHOLD, 1, 0)

for (this.col in colnames(train_msd))
{
  pfastopred[is.na(pfastopred[,this.col]),this.col] <- 
    train_msd[1, this.col]
}
```

## Scaling and centering on the training data mean and sd
```{r scale_and_center}
for (this.col in colnames(train_msd))
{
  pfastopred[,this.col] <- 
    (pfastopred[,this.col] - train_msd[1, this.col]) / 
    train_msd[2, this.col]
}
```

#Classification model predictions
```{r make_predictions}
load(file=paste0("RData/ClassificationModel_4Bin_EndoSimDisc_HLH_", 
                  MODELBUILDSUFF,
                  ".RData"))
set.seed(RNUMSEED)

pfastopred$HalfLife.Class <- predict(classmod4, newdata = pfastopred) 
```

```{r convert_class_to_hours}
pfastopred$HalfLife.Hours <-  4.9
pfastopred[pfastopred$HalfLife.Class %in% 2,
            "HalfLife.Hours"]<- signif(2.2 * 24, 2)
pfastopred[pfastopred$HalfLife.Class %in% 3,
            "HalfLife.Hours"]<- signif(33 * 24, 2)
pfastopred[pfastopred$HalfLife.Class %in% 4,
            "HalfLife.Hours"]<- signif(3.3 * 365 * 24, 2)
```

# Applicability Domain
This function implements the applicability domain estimation method of
Roy et al. 2015 (https://doi.org/10.1016/j.chemolab.2015.04.013), 
based on the descriptors that are scaled by those of the training set:
"...After a descriptor column is standardized based on the corresponding mean 
and standard deviation for the training set compounds only, if the 
corresponding standardized value for descriptor i of compound k (Ski) is more 
than 3, then the compound should be an X-outlier (if in the training set) or 
outside AD (if in the test set) based on descriptor i." To be consistent with 
Mansouri et al (https://doi.org/10.1186/s13321-018-0263-1) "1" indicates that
a chemical is within the applicability domain and "0" indicates the chemical 
is outside the domain. 
```{r applicability_domain_function}
ADfunction=function(model, data)
{
  vars=names(model$trainingData)
  vars=vars[-c(length(vars))] #removes last column which is predictions
# Separate the numeric descriptors ("a") from the categorical descriptors ("b")
# and only analyze the numeric descriptors:
  cats=which(vars%in%c("Species", "Sex", "DosingAdj"))
  Vars1=vars
  if(length(cats>0)){
    Vars1=vars[-c(which(vars%in%c("Species", "Sex",  "DosingAdj")))]}
  a=data
  b=a[,c("CASRN", "DTXSID","Species", "Sex",  "DosingAdj")]
  a=a[,which(names(a)%in%Vars1)]
  a=abs(a)
# Calculate SI -- the standardized value for descriptor "I"
  SImin=apply(a,1,min) #Find the min, max, sd, and mean
  SImax=apply(a,1,max)
  SImean=apply(a,1,mean)
  SIsd=apply(a,1,sd)
  SIdf=data.frame(data,SImin, SImax, SImean, SIsd)
  SIdf$SI90=SIdf$SImean + (1.28 * SIdf$SIsd)
# Initialize domain variable, chemicals are assumed to be inside the AD 
# unless found not be: 
  SIdf$Domain=1 
  
# Use Roy et al. (2015) criteria for outside of domain of applicability:
  SIdf$Domain=ifelse(SIdf$SImin>3, 0, ifelse((SIdf$SImean+(1.28*SIsd))>3,0,1))
  
  return(SIdf)
}
```


```{r predict_roy_applicability_domain}
Roy.AD <- ADfunction(model=classmod4, data=pfastopred)

pfastopred$Roy.AD <- Roy.AD$Domain
```

```{r write_results}
write.csv(pfastopred[,c("DTXSID",
                        predictors,
                        "HalfLife.Class",
                        "HalfLife.Hours",
                        "Roy.AD")],
          file=paste0("NewPFAS/",
                      OUTPUTFILE,
                      ".csv"),
          row.names=FALSE)
```
